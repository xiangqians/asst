<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!-- layui css -->
    <link href="../static/lib/layui-2.7.6/css/layui.css" rel="stylesheet">

    <!-- fullcalendar css -->
    <link href='../static/lib/fullcalendar-5.11.2/lib/main.min.css' rel='stylesheet' />

    <!-- style -->
    <style>

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        }

        #top {
            background: #eee;
            border-bottom: 1px solid #ddd;
            padding: 0 10px;
            line-height: 40px;
            font-size: 12px;
        }

        .left {
            float: left
        }

        .right {
            float: right
        }

        .clear {
            clear: both
        }

        #warning, #loading {
            display: none
        }

        #warning {
            font-weight: bold;
            color: red
        }

        #calendar {
            max-width: 80%;
            margin: 20px auto;
            padding: 0 10px;
        }

        .tzo {
            color: #000;
        }

    </style>
</head>
<body>
<div id='top'>
    <div class='left'>
        Timezone:
        <select id='time-zone-selector'>
        </select>

        Locales:
        <select id='locale-selector'></select>
    </div>

    <div class='right'>
        <span id='loading'>loading...</span>
        <span id='warning'>must be running.</span>
    </div>
    <div class='clear'></div>
</div>

<div id='calendar'></div>

<div class="layui-input-inline">
    <input id="start" class="layui-input" name="start" placeholder="开始时间" />
</div>

</body>
</html>

<!-- layui js -->
<script src="../static/lib/layui-2.7.6/layui.js"></script>

<!-- fullcalendar js -->
<script src='../static/lib/fullcalendar-5.11.2/lib/main.min.js'></script>
<script src='../static/lib/fullcalendar-5.11.2/lib/locales-all.min.js'></script>

<!-- custom -->
<script src='../static/js/utils.js'></script>

<!-- layui -->
<script>
    let layerPopUpBoxIndex = null;
    var editorHelper = null;

    function layerPopUpBox(title) {
        // https://www.layuiweb.com/doc/modules/layer.html
        layerPopUpBoxIndex = layer.open({
            // layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）。 若你采用layer.open({type: 1})方式调用，则type为必填项（信息框除外）
            type: 2,

            // area - 宽高
            // 类型：String/Array，默认：'auto'
            // 在默认状态下，layer是宽高都自适应的，但当你只想定义宽度时，你可以area: '500px'，高度仍然是自适应的。当你宽高都要定义时，你可以area: ['500px', '300px']
            area: ["800px", "600px"],

            title: title,

            // content
            content: './editor.html?id=1',

            // success
            success: function (layero, index) {
                let iframeWindow = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                // console.log(body.html()) //得到iframe页的body内容
                editorHelper = iframeWindow.editorHelper;
            },

            // end
            end: function () {
                console.log('end', editorHelper.getValue());
            }
        });
    }

    layui.use('laydate', function () {
        var laydate = layui.laydate;
        laydate.render({
            //指定元素
            elem: '#start',
            // year: 只提供年份列表选择
            // month: 只提供年份、月份列表选择
            // date: 可选择：年、月、日
            // time: 只提供时、分、秒选择
            // datetime: 可选择：年、月、日、时、分、秒
            type: 'datetime'
        });
    });

</script>


<!-- fullcalendar -->
<script>
    var initialLocaleCode = 'zh-cn';

    let doubleClickEvent = new Utils.DoubleClickEvent();

    document.addEventListener('DOMContentLoaded', function () {
        var initialTimeZone = 'local';
        var timeZoneSelectorEl = document.getElementById('time-zone-selector');
        var localeSelectorEl = document.getElementById('locale-selector');
        var loadingEl = document.getElementById('loading');
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {

            // 日历头部按钮位置
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',  // will normally be on the left. if RTL, will be on the right
                right: 'prevYear,nextYear dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },

            // 默认为那个视图（月：dayGridMonth，周：timeGridWeek，日：timeGridDay）
            // initialView: 'dayGridMonth',

            // 设置一周中显示的第一天是哪天，周日是0，周一是1，类推
            firstDay: 0,

            // 语言
            locale: initialLocaleCode,
            // 时区
            timeZone: initialTimeZone,

            // this allows things to be dropped onto the calendar
            // droppable: true,

            initialDate: '2020-09-12',
            // can click day/week names to navigate views
            // 允许天/周名称是否可点击，包括周次weekNumber，点击之后可以跳转到对于的天/周视图，默认false
            navLinks: true,
            // 是否可以进行（拖动、缩放）修改
            editable: false,
            // 是否可以选中日历格
            selectable: true,
            // allow "more" link when too many events
            dayMaxEvents: true,
            // Event日程开始时间可以改变，默认true，如果是false其实就是指日程块不能随意拖动，只能上下拉伸改变他的endTime
            // eventStartEditable: true,
            // 相同时间段的多个日程视觉上是否允许重叠，默认true允许
            // slotEventOverlap: false,

            events: {
                url: '../static/json/events.json',
                failure: function () {
                    document.getElementById('warning').style.display = 'inline'; // show
                }
            },
            loading: function (bool) {
                if (bool) {
                    loadingEl.style.display = 'inline'; // show
                } else {
                    loadingEl.style.display = 'none'; // hide
                }
            },

            eventTimeFormat: { hour: 'numeric', minute: '2-digit', timeZoneName: 'short' },

            // 切换视图调用的方法
            datesSet: function (arg) {
                // console.log('datesSet', arg)
            },

            // 选中日历格事件
            select: function (arg) {
                // console.log('select', calendar.formatIso(arg.start), calendar.formatIso(arg.end));
                // console.log('select', arg);
            },

            // 选中日期事件
            dateClick: function (arg) {
                doubleClickEvent.click(function () {
                    // console.log('dateClick', calendar.formatIso(arg.date));
                    layerPopUpBox("新增");
                });
            },

            // 点击日历日程事件
            eventClick: function (arg) {
                doubleClickEvent.click(function () {
                    // console.log('eventClick', arg);
                    layerPopUpBox("查看");
                });
            },

            // 拖动日历日程事件
            eventDrop: function (arg) {
                // console.log('eventDrop', arg);
            },

            // 鼠标滑过
            eventMouseEnter: function (arg) {
                // console.log('eventMouseEnter', arg);
            },

        });

        calendar.render();

        // build the locale selector's options
        calendar.getAvailableLocaleCodes().forEach(function (localeCode) {
            var optionEl = document.createElement('option');
            optionEl.value = localeCode;
            optionEl.selected = localeCode == initialLocaleCode;
            optionEl.innerText = localeCode;
            localeSelectorEl.appendChild(optionEl);
        });

        // when the selected option changes, dynamically change the calendar option
        localeSelectorEl.addEventListener('change', function () {
            if (this.value) {
                calendar.setOption('locale', this.value);
            }
        });

        // load the list of available timezones, build the <select> options
        // it's HIGHLY recommended to use a different library for network requests, not this internal util func
        FullCalendar.requestJson('GET', '../static/json/time-zones.json', {}, function (timeZones) {
            timeZones.forEach(function (timeZone) {
                var optionEl = document.createElement('option');
                optionEl.value = timeZone;
                optionEl.innerText = timeZone;
                timeZoneSelectorEl.appendChild(optionEl);
            });
        }, function () {
            // TODO: handle error
        });

        // when the timezone selector changes, dynamically change the calendar option
        timeZoneSelectorEl.addEventListener('change', function () {
            calendar.setOption('timeZone', this.value);
        });
    });

</script>

<!-- document -->
<script>
    document.onkeydown = function (event) {
        // console.log(event);

        // Esc
        if (event.code == 'Escape') {
            if (layerPopUpBoxIndex != null) {
                layer.close(layerPopUpBoxIndex);
                layerPopUpBoxIndex = null;
            }
        }
    }
</script>
